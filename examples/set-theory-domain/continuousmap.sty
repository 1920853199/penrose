Const {
  Const.strokeWidth = 1.5
  Const.padding = 20.0
}

Colors {
  Colors.black = rgba(0.0, 0.0, 0.0, 1.0)
  Colors.lightBlue = rgba(0.1, 0.1, 0.9, 0.2)
  Colors.lightYellow = rgba(0.95, 0.96, 0.92, 0.5)
}

Set x {
    x.shape = Circle {
        color : Colors.lightBlue
        strokeColor : Colors.black
        strokeStyle : "solid"
        strokeWidth : 1.0
        rotation : 0.0
    }

    x.text    = Text {
      string : x.label
      rotation : 0.0
    }

    x.labelFn = ensure contains(x.shape, x.text)
    x.shape below x.text
}

-- Selector ordering matters!
Set x; Set y
where IsSubset(x, y) {
  ensure contains(y.shape, x.shape, 10.0)
  -- y.sizeFn    = ensure smallerThan(x.shape, y.shape)
  y.outsideFn = ensure outsideOf(y.text, x.shape, 1.0)
  x.shape above y.shape
}

Map f
where From(f, X, Y); IsSubset(X, R1); IsSubset(Y, R2)
with Set X; Set Y; Set R1; Set R2 {
  f.padding = 20.0

    f.shape = Arrow {
      start : (R1.shape.center[0] + R1.shape.side / 2.0 + f.padding, R1.shape.center[1])
      end : (R2.shape.center[0] - R2.shape.side / 2.0 - f.padding, R2.shape.center[1])
      thickness : 2.0
      color : Colors.black
        -- style : "curved"
    }

    f.text     = Text {
      -- Doesn't seem to work after the first resample. Is the server updating f.text.h on resample?
      -- x : (f.shape.startX + f.shape.endX) / 2.0
      -- y : (f.shape.startY + f.shape.endY) / 2.0 + 1.1 * f.text.h
      string : f.label
      rotation : 0.0
    }

    encourage centerLabel(f.shape, f.text, 5.0)

    -- Unused?
    -- f.centerFn = encourage centerArrow(f.shape, R1.shape, R2.shape)
}

Set `U` {
    override `U`.shape.strokeStyle = "dashed"
    override `U`.shape.strokeWidth = Const.strokeWidth
}

Set `V` {
    override `V`.shape.strokeStyle = "dashed"
    override `V`.shape.strokeWidth = Const.strokeWidth
}

-- TODO: use subtyping for reals?
Set `Rn` {
    override `Rn`.shape = Square {
      -- Works but is slow
      -- x : -100.0
      -- y = 0.0
      color : Colors.lightYellow
      rotation : 0.0
      strokeWidth : Const.strokeWidth
      strokeColor : Colors.black
    }

    override `Rn`.text.center = (`Rn`.shape.center[0] + `Rn`.shape.side / 2.0 - Const.padding, `Rn`.shape.center[1] + `Rn`.shape.side / 2.0 - Const.padding)

    delete `Rn`.labelFn
    delete `Rn`.outsideFn

    ensure minSize(`Rn`.shape)
    ensure maxSize(`Rn`.shape)
}

Set `Rm`
with Set `Rn` {
    -- TODO: factor this block out
    override `Rm`.shape = Square {
        color : Colors.lightYellow
        center : (`Rn`.shape.center[0] + 400.0, `Rn`.shape.center[1])
        side  : `Rn`.shape.side
        rotation : 0.0
        strokeWidth : 1.0
        strokeColor : Colors.black
    }

     override `Rm`.text.center = (`Rm`.shape.center[0] + `Rm`.shape.side / 2.0 - Const.padding, `Rm`.shape.center[1] + `Rm`.shape.side / 2.0 - Const.padding)

    delete `Rm`.labelFn
    delete `Rm`.outsideFn

    -- This doesn't seem to work
    --    `Rm`.posFn = encourage topRightOf(`Rm`.text, `Rm`.shape)

    ensure minSize(`Rm`.shape)
    ensure maxSize(`Rm`.shape)
}